{{- if .Values.monitoring.prometheusRule.enabled }}
{{- $fullName := include "linguagap.fullname" . }}
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: {{ $fullName }}
  labels:
    {{- include "linguagap.labels" . | nindent 4 }}
    {{- with .Values.monitoring.prometheusRule.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
spec:
  groups:
    - name: {{ $fullName }}.rules
      rules:
        # Pod not ready
        - alert: LinguagapPodNotReady
          expr: |
            kube_pod_status_ready{namespace="{{ .Release.Namespace }}", pod=~"{{ $fullName }}.*", condition="true"} == 0
          for: 5m
          labels:
            severity: WARNING
            app: linguagap
            namespace: {{ .Release.Namespace }}
          annotations:
            summary: "LinguaGap pod not ready"
            description: "Pod {{ "{{" }} $labels.pod {{ "}}" }} in namespace {{ .Release.Namespace }} is not ready"

        # Pod restarts
        - alert: LinguagapPodRestarting
          expr: |
            increase(kube_pod_container_status_restarts_total{namespace="{{ .Release.Namespace }}", pod=~"{{ $fullName }}.*"}[1h]) > 3
          for: 5m
          labels:
            severity: WARNING
            app: linguagap
            namespace: {{ .Release.Namespace }}
          annotations:
            summary: "LinguaGap pod restarting frequently"
            description: "Pod {{ "{{" }} $labels.pod {{ "}}" }} has restarted {{ "{{" }} $value {{ "}}" }} times in the last hour"

        # High memory usage
        - alert: LinguagapHighMemoryUsage
          expr: |
            container_memory_working_set_bytes{namespace="{{ .Release.Namespace }}", pod=~"{{ $fullName }}.*", container!=""}
            / on(pod) kube_pod_container_resource_limits{namespace="{{ .Release.Namespace }}", pod=~"{{ $fullName }}.*", resource="memory"}
            > 0.9
          for: 5m
          labels:
            severity: WARNING
            app: linguagap
            namespace: {{ .Release.Namespace }}
          annotations:
            summary: "LinguaGap high memory usage"
            description: "Container {{ "{{" }} $labels.container {{ "}}" }} is using more than 90% of its memory limit"

        # No replicas available
        - alert: LinguagapNoReplicasAvailable
          expr: |
            kube_deployment_status_replicas_available{namespace="{{ .Release.Namespace }}", deployment="{{ $fullName }}"} == 0
          for: 1m
          labels:
            severity: CRITICAL
            app: linguagap
            namespace: {{ .Release.Namespace }}
            groupKey: linguagap
          annotations:
            summary: "LinguaGap has no available replicas"
            description: "Deployment {{ $fullName }} in namespace {{ .Release.Namespace }} has no available replicas"

        # GPU not available (specific to LinguaGap)
        - alert: LinguagapGpuNotAvailable
          expr: |
            kube_pod_container_resource_requests{namespace="{{ .Release.Namespace }}", pod=~"{{ $fullName }}.*", resource="nvidia_com_gpu"} > 0
            unless on(pod)
            kube_pod_status_ready{namespace="{{ .Release.Namespace }}", pod=~"{{ $fullName }}.*", condition="true"} == 1
          for: 10m
          labels:
            severity: WARNING
            app: linguagap
            namespace: {{ .Release.Namespace }}
          annotations:
            summary: "LinguaGap GPU pod not ready"
            description: "GPU-enabled pod {{ "{{" }} $labels.pod {{ "}}" }} is not ready - possible GPU allocation issue"
{{- end }}
