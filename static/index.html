<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SYNIA - Real-time Speech Translation</title>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --synia-teal: #0099a8;
            --synia-teal-dark: #007a87;
            --synia-teal-light: #00b4c5;
            --synia-dark: #1f1f1f;
            --synia-text: rgba(18, 18, 18, 0.75);
            --synia-text-dark: #121212;
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Assistant', sans-serif;
            background: #ffffff;
            color: var(--synia-text);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }
        .logo {
            max-height: 60px;
            margin-bottom: 10px;
        }
        h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            color: var(--synia-dark);
            font-weight: 600;
        }
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        select, button {
            padding: 12px 24px;
            font-size: 1rem;
            border: 1px solid #ccc;
            border-radius: 8px;
            cursor: pointer;
        }
        select {
            background: #fff;
            color: var(--synia-text-dark);
            min-width: 150px;
            font-family: 'Assistant', sans-serif;
        }
        select:focus, button:focus {
            outline: 2px solid var(--synia-teal);
            outline-offset: 2px;
        }
        button {
            background: var(--synia-teal);
            color: #fff;
            border: none;
            transition: background 0.2s;
            font-family: 'Assistant', sans-serif;
            font-weight: 600;
        }
        button:hover {
            background: var(--synia-teal-dark);
        }
        button.recording {
            background: #d9534f;
        }
        button.recording:hover {
            background: #c9302c;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .panes {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 768px) {
            .panes {
                grid-template-columns: 1fr;
            }
        }
        .pane {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            min-height: 400px;
            max-height: 70vh;
            overflow-y: auto;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .pane h2 {
            font-size: 1.2rem;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--synia-teal);
            color: var(--synia-dark);
            font-weight: 600;
        }
        .transcript {
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .bubble {
            max-width: 85%;
            padding: 10px 14px;
            border-radius: 18px;
            word-wrap: break-word;
        }
        .bubble.speaker-left {
            align-self: flex-start;
            background: #e8e8e8;
            border-bottom-left-radius: 4px;
        }
        .bubble.speaker-right {
            align-self: flex-end;
            background: var(--synia-teal);
            color: white;
            border-bottom-right-radius: 4px;
        }
        .bubble.live {
            opacity: 0.7;
            font-style: italic;
        }
        .bubble.live.speaker-left {
            border-left: 3px solid #d9534f;
        }
        .bubble.live.speaker-right {
            border-right: 3px solid #d9534f;
        }
        .status {
            text-align: center;
            padding: 10px;
            font-size: 0.9rem;
            color: #666;
        }
        .status.connected {
            color: var(--synia-teal);
        }
        .status.error {
            color: #d9534f;
        }
        /* Dual-channel indicator */
        .dual-channel-badge {
            display: none;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            background: #d4edda;
            color: #155724;
            margin-left: 10px;
            vertical-align: middle;
        }
        .dual-channel-badge.active {
            display: inline-block;
        }
        /* QR Code sidebar styles */
        .qr-sidebar {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .qr-sidebar h3 {
            font-size: 1rem;
            margin-bottom: 8px;
            color: var(--synia-dark);
            font-weight: 600;
        }
        .qr-sidebar p {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 15px;
        }
        #qrCode {
            margin: 0 auto 15px;
        }
        #qrCode canvas {
            border-radius: 8px;
        }
        .viewer-url {
            font-family: monospace;
            font-size: 0.7rem;
            background: #f5f5f5;
            padding: 8px;
            border-radius: 6px;
            word-break: break-all;
            color: #333;
        }
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 260px;
            gap: 20px;
        }
        @media (max-width: 1024px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
            .qr-sidebar {
                order: -1;
            }
        }

        /* UI Language selector */
        .ui-lang-select {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 6px 10px;
            font-size: 0.9rem;
            border: 1px solid #ccc;
            border-radius: 6px;
            background: #fff;
            cursor: pointer;
            font-family: 'Assistant', sans-serif;
        }
        .ui-lang-select:focus {
            outline: 2px solid var(--synia-teal);
            outline-offset: 2px;
        }

        /* Speaker label styles */
        .speaker-label {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
            opacity: 0.7;
        }
        .bubble.speaker-left .speaker-label {
            color: #666;
        }
        .bubble.speaker-right .speaker-label {
            color: rgba(255, 255, 255, 0.8);
        }
        .bubble-content {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <img src="/static/synia-logo.png" alt="SYNIA Solutions" class="logo">
            <p id="subtitle">Real-time Speech Transcription & Translation</p>
            <select id="uiLangSelect" class="ui-lang-select" title="Interface Language">
                <option value="de">ðŸ‡©ðŸ‡ª DE</option>
                <option value="en">ðŸ‡¬ðŸ‡§ EN</option>
            </select>
        </header>

        <div class="controls">
            <select id="audioInputSelect" title="Microphone">
                <option value="">Default Microphone</option>
            </select>
            <select id="languageSelect">
                <option value="" disabled selected>-- Select Language --</option>
                <option value="en">English</option>
                <option value="fr">French</option>
                <option value="es">Spanish</option>
                <option value="it">Italian</option>
                <option value="pl">Polish</option>
                <option value="ro">Romanian</option>
                <option value="hr">Croatian</option>
                <option value="bg">Bulgarian</option>
                <option value="tr">Turkish</option>
                <option value="ru">Russian</option>
                <option value="uk">Ukrainian</option>
                <option value="hu">Hungarian</option>
                <option value="ar">Arabic</option>
                <option value="fa">Persian</option>
                <option value="sr">Serbian</option>
            </select>
            <button id="startBtn">Start Recording</button>
            <button id="clearBtn">Clear</button>
        </div>

        <div class="status" id="status">Click "Start Recording" to begin<span class="dual-channel-badge" id="dualChannelBadge">Dual Channel</span></div>

        <div class="main-layout">
        <div class="panes">
            <div class="pane">
                <h2 id="leftLangLabel">Foreign Language</h2>
                <div class="transcript" id="leftTranscript"></div>
            </div>
            <div class="pane">
                <h2 id="rightLangLabel">German</h2>
                <div class="transcript" id="rightTranscript"></div>
            </div>
        </div>

        <!-- QR Code Sidebar -->
        <div class="qr-sidebar">
            <h3>Share with Foreign Speaker</h3>
            <p>Scan to view live transcript</p>
            <div id="qrCode"></div>
            <div class="viewer-url" id="viewerUrlText"></div>
        </div>
        </div>
    </div>

    <!-- QR Code Generator Library (qrcode-generator, MIT licensed, ~5KB) -->
    <script>
        // qrcode-generator v1.4.4 - https://github.com/kazuhikoarase/qrcode-generator
        var qrcode=function(){var qrcode=function(typeNumber,errorCorrectionLevel){var PAD0=0xEC;var PAD1=0x11;var _typeNumber=typeNumber;var _errorCorrectionLevel=QRErrorCorrectionLevel[errorCorrectionLevel];var _modules=null;var _moduleCount=0;var _dataCache=null;var _dataList=[];var _this={};var makeImpl=function(test,maskPattern){_moduleCount=_typeNumber*4+17;_modules=function(moduleCount){var modules=new Array(moduleCount);for(var row=0;row<moduleCount;row+=1){modules[row]=new Array(moduleCount);for(var col=0;col<moduleCount;col+=1){modules[row][col]=null;}}return modules;}(_moduleCount);setupPositionProbePattern(0,0);setupPositionProbePattern(_moduleCount-7,0);setupPositionProbePattern(0,_moduleCount-7);setupPositionAdjustPattern();setupTimingPattern();setupTypeInfo(test,maskPattern);if(_typeNumber>=7){setupTypeNumber(test);}if(_dataCache==null){_dataCache=createData(_typeNumber,_errorCorrectionLevel,_dataList);}mapData(_dataCache,maskPattern);};var setupPositionProbePattern=function(row,col){for(var r=-1;r<=7;r+=1){if(row+r<=-1||_moduleCount<=row+r)continue;for(var c=-1;c<=7;c+=1){if(col+c<=-1||_moduleCount<=col+c)continue;if((0<=r&&r<=6&&(c==0||c==6))||(0<=c&&c<=6&&(r==0||r==6))||(2<=r&&r<=4&&2<=c&&c<=4)){_modules[row+r][col+c]=true;}else{_modules[row+r][col+c]=false;}}}};var getBestMaskPattern=function(){var minLostPoint=0;var pattern=0;for(var i=0;i<8;i+=1){makeImpl(true,i);var lostPoint=QRUtil.getLostPoint(_this);if(i==0||minLostPoint>lostPoint){minLostPoint=lostPoint;pattern=i;}}return pattern;};var setupTimingPattern=function(){for(var r=8;r<_moduleCount-8;r+=1){if(_modules[r][6]!=null){continue;}_modules[r][6]=(r%2==0);}for(var c=8;c<_moduleCount-8;c+=1){if(_modules[6][c]!=null){continue;}_modules[6][c]=(c%2==0);}};var setupPositionAdjustPattern=function(){var pos=QRUtil.getPatternPosition(_typeNumber);for(var i=0;i<pos.length;i+=1){for(var j=0;j<pos.length;j+=1){var row=pos[i];var col=pos[j];if(_modules[row][col]!=null){continue;}for(var r=-2;r<=2;r+=1){for(var c=-2;c<=2;c+=1){if(r==-2||r==2||c==-2||c==2||(r==0&&c==0)){_modules[row+r][col+c]=true;}else{_modules[row+r][col+c]=false;}}}}}};var setupTypeNumber=function(test){var bits=QRUtil.getBCHTypeNumber(_typeNumber);for(var i=0;i<18;i+=1){var mod=(!test&&((bits>>i)&1)==1);_modules[Math.floor(i/3)][i%3+_moduleCount-8-3]=mod;}for(var i=0;i<18;i+=1){var mod=(!test&&((bits>>i)&1)==1);_modules[i%3+_moduleCount-8-3][Math.floor(i/3)]=mod;}};var setupTypeInfo=function(test,maskPattern){var data=(_errorCorrectionLevel<<3)|maskPattern;var bits=QRUtil.getBCHTypeInfo(data);for(var i=0;i<15;i+=1){var mod=(!test&&((bits>>i)&1)==1);if(i<6){_modules[i][8]=mod;}else if(i<8){_modules[i+1][8]=mod;}else{_modules[_moduleCount-15+i][8]=mod;}}for(var i=0;i<15;i+=1){var mod=(!test&&((bits>>i)&1)==1);if(i<8){_modules[8][_moduleCount-i-1]=mod;}else if(i<9){_modules[8][15-i-1+1]=mod;}else{_modules[8][15-i-1]=mod;}}_modules[_moduleCount-8][8]=(!test);};var mapData=function(data,maskPattern){var inc=-1;var row=_moduleCount-1;var bitIndex=7;var byteIndex=0;var maskFunc=QRUtil.getMaskFunction(maskPattern);for(var col=_moduleCount-1;col>0;col-=2){if(col==6)col-=1;while(true){for(var c=0;c<2;c+=1){if(_modules[row][col-c]==null){var dark=false;if(byteIndex<data.length){dark=(((data[byteIndex]>>>bitIndex)&1)==1);}if(maskFunc(row,col-c)){dark=!dark;}_modules[row][col-c]=dark;bitIndex-=1;if(bitIndex==-1){byteIndex+=1;bitIndex=7;}}}row+=inc;if(row<0||_moduleCount<=row){row-=inc;inc=-inc;break;}}}};var createBytes=function(buffer,rsBlocks){var offset=0;var maxDcCount=0;var maxEcCount=0;var dcdata=new Array(rsBlocks.length);var ecdata=new Array(rsBlocks.length);for(var r=0;r<rsBlocks.length;r+=1){var dcCount=rsBlocks[r].dataCount;var ecCount=rsBlocks[r].totalCount-dcCount;maxDcCount=Math.max(maxDcCount,dcCount);maxEcCount=Math.max(maxEcCount,ecCount);dcdata[r]=new Array(dcCount);for(var i=0;i<dcdata[r].length;i+=1){dcdata[r][i]=0xff&buffer.getBuffer()[i+offset];}offset+=dcCount;var rsPoly=QRUtil.getErrorCorrectPolynomial(ecCount);var rawPoly=qrPolynomial(dcdata[r],rsPoly.getLength()-1);var modPoly=rawPoly.mod(rsPoly);ecdata[r]=new Array(rsPoly.getLength()-1);for(var i=0;i<ecdata[r].length;i+=1){var modIndex=i+modPoly.getLength()-ecdata[r].length;ecdata[r][i]=(modIndex>=0)?modPoly.getAt(modIndex):0;}}var totalCodeCount=0;for(var i=0;i<rsBlocks.length;i+=1){totalCodeCount+=rsBlocks[i].totalCount;}var data=new Array(totalCodeCount);var index=0;for(var i=0;i<maxDcCount;i+=1){for(var r=0;r<rsBlocks.length;r+=1){if(i<dcdata[r].length){data[index]=dcdata[r][i];index+=1;}}}for(var i=0;i<maxEcCount;i+=1){for(var r=0;r<rsBlocks.length;r+=1){if(i<ecdata[r].length){data[index]=ecdata[r][i];index+=1;}}}return data;};var createData=function(typeNumber,errorCorrectionLevel,dataList){var rsBlocks=QRRSBlock.getRSBlocks(typeNumber,errorCorrectionLevel);var buffer=qrBitBuffer();for(var i=0;i<dataList.length;i+=1){var data=dataList[i];buffer.put(data.getMode(),4);buffer.put(data.getLength(),QRUtil.getLengthInBits(data.getMode(),typeNumber));data.write(buffer);}var totalDataCount=0;for(var i=0;i<rsBlocks.length;i+=1){totalDataCount+=rsBlocks[i].dataCount;}if(buffer.getLengthInBits()>totalDataCount*8){throw'code length overflow. ('+buffer.getLengthInBits()+'>'+totalDataCount*8+')';}if(buffer.getLengthInBits()+4<=totalDataCount*8){buffer.put(0,4);}while(buffer.getLengthInBits()%8!=0){buffer.putBit(false);}while(true){if(buffer.getLengthInBits()>=totalDataCount*8){break;}buffer.put(PAD0,8);if(buffer.getLengthInBits()>=totalDataCount*8){break;}buffer.put(PAD1,8);}return createBytes(buffer,rsBlocks);};_this.addData=function(data,mode){mode=mode||'Byte';var newData=null;switch(mode){case'Numeric':newData=qrNumber(data);break;case'Alphanumeric':newData=qrAlphaNum(data);break;case'Byte':newData=qr8BitByte(data);break;case'Kanji':newData=qrKanji(data);break;default:throw'mode:'+mode;}_dataList.push(newData);_dataCache=null;};_this.isDark=function(row,col){if(row<0||_moduleCount<=row||col<0||_moduleCount<=col){throw row+','+col;}return _modules[row][col];};_this.getModuleCount=function(){return _moduleCount;};_this.make=function(){if(_typeNumber<1){var typeNumber=1;for(;typeNumber<40;typeNumber++){var rsBlocks=QRRSBlock.getRSBlocks(typeNumber,_errorCorrectionLevel);var buffer=qrBitBuffer();for(var i=0;i<_dataList.length;i+=1){var data=_dataList[i];buffer.put(data.getMode(),4);buffer.put(data.getLength(),QRUtil.getLengthInBits(data.getMode(),typeNumber));data.write(buffer);}var totalDataCount=0;for(var i=0;i<rsBlocks.length;i+=1){totalDataCount+=rsBlocks[i].dataCount;}if(buffer.getLengthInBits()<=totalDataCount*8){break;}}_typeNumber=typeNumber;}makeImpl(false,getBestMaskPattern());};_this.createTableTag=function(cellSize,margin){cellSize=cellSize||2;margin=(typeof margin=='undefined')?cellSize*4:margin;var qrHtml='';qrHtml+='<table style="';qrHtml+=' border-width: 0px; border-style: none;';qrHtml+=' border-collapse: collapse;';qrHtml+=' padding: 0px; margin: '+margin+'px;';qrHtml+='">';qrHtml+='<tbody>';for(var r=0;r<_this.getModuleCount();r+=1){qrHtml+='<tr>';for(var c=0;c<_this.getModuleCount();c+=1){qrHtml+='<td style="';qrHtml+=' border-width: 0px; border-style: none;';qrHtml+=' border-collapse: collapse;';qrHtml+=' padding: 0px; margin: 0px;';qrHtml+=' width: '+cellSize+'px;';qrHtml+=' height: '+cellSize+'px;';qrHtml+=' background-color: ';qrHtml+=_this.isDark(r,c)?'#000000':'#ffffff';qrHtml+=';';qrHtml+='"/>';}qrHtml+='</tr>';}qrHtml+='</tbody>';qrHtml+='</table>';return qrHtml;};_this.createSvgTag=function(cellSize,margin){cellSize=cellSize||2;margin=(typeof margin=='undefined')?cellSize*4:margin;var size=_this.getModuleCount()*cellSize+margin*2;var c,mc,r,mr,qrSvg='',rect;rect='l'+cellSize+',0 0,'+cellSize+' -'+cellSize+',0 0,-'+cellSize+'z ';qrSvg+='<svg version="1.1" xmlns="http://www.w3.org/2000/svg"';qrSvg+=' width="'+size+'px"';qrSvg+=' height="'+size+'px"';qrSvg+=' viewBox="0 0 '+size+' '+size+'" ';qrSvg+=' preserveAspectRatio="xMinYMin meet">';qrSvg+='<rect width="100%" height="100%" fill="white" cx="0" cy="0"/>';qrSvg+='<path d="';for(r=0;r<_this.getModuleCount();r+=1){mr=r*cellSize+margin;for(c=0;c<_this.getModuleCount();c+=1){if(_this.isDark(r,c)){mc=c*cellSize+margin;qrSvg+='M'+mc+','+mr+rect;}}}qrSvg+='" stroke="transparent" fill="black"/>';qrSvg+='</svg>';return qrSvg;};_this.createDataURL=function(cellSize,margin){cellSize=cellSize||2;margin=(typeof margin=='undefined')?cellSize*4:margin;var size=_this.getModuleCount()*cellSize+margin*2;var min=margin;var max=size-margin;return createDataURL(size,size,function(x,y){if(min<=x&&x<max&&min<=y&&y<max){var c=Math.floor((x-min)/cellSize);var r=Math.floor((y-min)/cellSize);return _this.isDark(r,c)?0:1;}else{return 1;}});};_this.createImgTag=function(cellSize,margin,alt){cellSize=cellSize||2;margin=(typeof margin=='undefined')?cellSize*4:margin;var size=_this.getModuleCount()*cellSize+margin*2;var img='';img+='<img';img+=' src="';img+=_this.createDataURL(cellSize,margin);img+='"';img+=' width="'+size+'"';img+=' height="'+size+'"';if(alt){img+=' alt="'+alt+'"';}img+='/>';return img;};var createDataURL=function(width,height,getPixel){var gif=gifImage(width,height);for(var y=0;y<height;y+=1){for(var x=0;x<width;x+=1){gif.setPixel(x,y,getPixel(x,y));}}return gif.toDataURL();};_this.renderTo2dContext=function(context,cellSize){cellSize=cellSize||2;var length=_this.getModuleCount();for(var row=0;row<length;row++){for(var col=0;col<length;col++){context.fillStyle=_this.isDark(row,col)?'black':'white';context.fillRect(col*cellSize,row*cellSize,cellSize,cellSize);}}};return _this;};qrcode.stringToBytes=(function(){return function(s){var bytes=[];for(var i=0;i<s.length;i+=1){var c=s.charCodeAt(i);if(c<128){bytes.push(c);}else if(c<2048){bytes.push(192|(c>>6));bytes.push(128|(c&63));}else if(c<65536){bytes.push(224|(c>>12));bytes.push(128|((c>>6)&63));bytes.push(128|(c&63));}else{bytes.push(240|(c>>18));bytes.push(128|((c>>12)&63));bytes.push(128|((c>>6)&63));bytes.push(128|(c&63));}}return bytes;};})();qrcode.createStringToBytes=function(unicodeData,numChars){var unicodeMap=function(){var bin=atob(unicodeData);var helper=function(s){var bytes=[];for(var i=0;i<s.length;i+=1){bytes.push(s.charCodeAt(i));}return bytes;};return helper(bin);}();var unknownChar='?'.charCodeAt(0);return function(s){var bytes=[];for(var i=0;i<s.length;i+=1){var c=s.charCodeAt(i);if(c<128){bytes.push(c);}else{var b=unknownChar;for(var j=0;j<unicodeMap.length;j+=numChars){if(unicodeMap[j]==c){if(numChars==1){b=unicodeMap[j+1];}else{b=((unicodeMap[j+1]<<8)|unicodeMap[j+2]);}break;}}if(numChars==1){bytes.push(b);}else{bytes.push(b>>>8);bytes.push(b&255);}}}return bytes;};};var QRMode={MODE_NUMBER:1<<0,MODE_ALPHA_NUM:1<<1,MODE_8BIT_BYTE:1<<2,MODE_KANJI:1<<3};var QRErrorCorrectionLevel={L:1,M:0,Q:3,H:2};var QRMaskPattern={PATTERN000:0,PATTERN001:1,PATTERN010:2,PATTERN011:3,PATTERN100:4,PATTERN101:5,PATTERN110:6,PATTERN111:7};var QRUtil=function(){var PATTERN_POSITION_TABLE=[[],[6,18],[6,22],[6,26],[6,30],[6,34],[6,22,38],[6,24,42],[6,26,46],[6,28,50],[6,30,54],[6,32,58],[6,34,62],[6,26,46,66],[6,26,48,70],[6,26,50,74],[6,30,54,78],[6,30,56,82],[6,30,58,86],[6,34,62,90],[6,28,50,72,94],[6,26,50,74,98],[6,30,54,78,102],[6,28,54,80,106],[6,32,58,84,110],[6,30,58,86,114],[6,34,62,90,118],[6,26,50,74,98,122],[6,30,54,78,102,126],[6,26,52,78,104,130],[6,30,56,82,108,134],[6,34,60,86,112,138],[6,30,58,86,114,142],[6,34,62,90,118,146],[6,30,54,78,102,126,150],[6,24,50,76,102,128,154],[6,28,54,80,106,132,158],[6,32,58,84,110,136,162],[6,26,54,82,110,138,166],[6,30,58,86,114,142,170]];var G15=(1<<10)|(1<<8)|(1<<5)|(1<<4)|(1<<2)|(1<<1)|(1<<0);var G18=(1<<12)|(1<<11)|(1<<10)|(1<<9)|(1<<8)|(1<<5)|(1<<2)|(1<<0);var G15_MASK=(1<<14)|(1<<12)|(1<<10)|(1<<4)|(1<<1);var _this={};var getBCHDigit=function(data){var digit=0;while(data!=0){digit+=1;data>>>=1;}return digit;};_this.getBCHTypeInfo=function(data){var d=data<<10;while(getBCHDigit(d)-getBCHDigit(G15)>=0){d^=(G15<<(getBCHDigit(d)-getBCHDigit(G15)));}return((data<<10)|d)^G15_MASK;};_this.getBCHTypeNumber=function(data){var d=data<<12;while(getBCHDigit(d)-getBCHDigit(G18)>=0){d^=(G18<<(getBCHDigit(d)-getBCHDigit(G18)));}return(data<<12)|d;};_this.getPatternPosition=function(typeNumber){return PATTERN_POSITION_TABLE[typeNumber-1];};_this.getMaskFunction=function(maskPattern){switch(maskPattern){case QRMaskPattern.PATTERN000:return function(i,j){return(i+j)%2==0;};case QRMaskPattern.PATTERN001:return function(i,j){return i%2==0;};case QRMaskPattern.PATTERN010:return function(i,j){return j%3==0;};case QRMaskPattern.PATTERN011:return function(i,j){return(i+j)%3==0;};case QRMaskPattern.PATTERN100:return function(i,j){return(Math.floor(i/2)+Math.floor(j/3))%2==0;};case QRMaskPattern.PATTERN101:return function(i,j){return(i*j)%2+(i*j)%3==0;};case QRMaskPattern.PATTERN110:return function(i,j){return((i*j)%2+(i*j)%3)%2==0;};case QRMaskPattern.PATTERN111:return function(i,j){return((i*j)%3+(i+j)%2)%2==0;};default:throw'bad maskPattern:'+maskPattern;}};_this.getErrorCorrectPolynomial=function(errorCorrectLength){var a=qrPolynomial([1],0);for(var i=0;i<errorCorrectLength;i+=1){a=a.multiply(qrPolynomial([1,QRMath.gexp(i)],0));}return a;};_this.getLengthInBits=function(mode,type){if(1<=type&&type<10){switch(mode){case QRMode.MODE_NUMBER:return 10;case QRMode.MODE_ALPHA_NUM:return 9;case QRMode.MODE_8BIT_BYTE:return 8;case QRMode.MODE_KANJI:return 8;default:throw'mode:'+mode;}}else if(type<27){switch(mode){case QRMode.MODE_NUMBER:return 12;case QRMode.MODE_ALPHA_NUM:return 11;case QRMode.MODE_8BIT_BYTE:return 16;case QRMode.MODE_KANJI:return 10;default:throw'mode:'+mode;}}else if(type<41){switch(mode){case QRMode.MODE_NUMBER:return 14;case QRMode.MODE_ALPHA_NUM:return 13;case QRMode.MODE_8BIT_BYTE:return 16;case QRMode.MODE_KANJI:return 12;default:throw'mode:'+mode;}}else{throw'type:'+type;}};_this.getLostPoint=function(qrcode){var moduleCount=qrcode.getModuleCount();var lostPoint=0;for(var row=0;row<moduleCount;row+=1){for(var col=0;col<moduleCount;col+=1){var sameCount=0;var dark=qrcode.isDark(row,col);for(var r=-1;r<=1;r+=1){if(row+r<0||moduleCount<=row+r){continue;}for(var c=-1;c<=1;c+=1){if(col+c<0||moduleCount<=col+c){continue;}if(r==0&&c==0){continue;}if(dark==qrcode.isDark(row+r,col+c)){sameCount+=1;}}}if(sameCount>5){lostPoint+=(3+sameCount-5);}}}for(var row=0;row<moduleCount-1;row+=1){for(var col=0;col<moduleCount-1;col+=1){var count=0;if(qrcode.isDark(row,col))count+=1;if(qrcode.isDark(row+1,col))count+=1;if(qrcode.isDark(row,col+1))count+=1;if(qrcode.isDark(row+1,col+1))count+=1;if(count==0||count==4){lostPoint+=3;}}}for(var row=0;row<moduleCount;row+=1){for(var col=0;col<moduleCount-6;col+=1){if(qrcode.isDark(row,col)&&!qrcode.isDark(row,col+1)&&qrcode.isDark(row,col+2)&&qrcode.isDark(row,col+3)&&qrcode.isDark(row,col+4)&&!qrcode.isDark(row,col+5)&&qrcode.isDark(row,col+6)){lostPoint+=40;}}}for(var col=0;col<moduleCount;col+=1){for(var row=0;row<moduleCount-6;row+=1){if(qrcode.isDark(row,col)&&!qrcode.isDark(row+1,col)&&qrcode.isDark(row+2,col)&&qrcode.isDark(row+3,col)&&qrcode.isDark(row+4,col)&&!qrcode.isDark(row+5,col)&&qrcode.isDark(row+6,col)){lostPoint+=40;}}}var darkCount=0;for(var col=0;col<moduleCount;col+=1){for(var row=0;row<moduleCount;row+=1){if(qrcode.isDark(row,col)){darkCount+=1;}}}var ratio=Math.abs(100*darkCount/moduleCount/moduleCount-50)/5;lostPoint+=ratio*10;return lostPoint;};return _this;}();var QRMath=function(){var EXP_TABLE=new Array(256);var LOG_TABLE=new Array(256);for(var i=0;i<8;i+=1){EXP_TABLE[i]=1<<i;}for(var i=8;i<256;i+=1){EXP_TABLE[i]=EXP_TABLE[i-4]^EXP_TABLE[i-5]^EXP_TABLE[i-6]^EXP_TABLE[i-8];}for(var i=0;i<255;i+=1){LOG_TABLE[EXP_TABLE[i]]=i;}var _this={};_this.glog=function(n){if(n<1){throw'glog('+n+')';}return LOG_TABLE[n];};_this.gexp=function(n){while(n<0){n+=255;}while(n>=256){n-=255;}return EXP_TABLE[n];};return _this;}();function qrPolynomial(num,shift){if(typeof num.length=='undefined'){throw num.length+'/'+shift;}var _num=function(){var offset=0;while(offset<num.length&&num[offset]==0){offset+=1;}var _num=new Array(num.length-offset+shift);for(var i=0;i<num.length-offset;i+=1){_num[i]=num[i+offset];}return _num;}();var _this={};_this.getAt=function(index){return _num[index];};_this.getLength=function(){return _num.length;};_this.multiply=function(e){var num=new Array(_this.getLength()+e.getLength()-1);for(var i=0;i<_this.getLength();i+=1){for(var j=0;j<e.getLength();j+=1){num[i+j]^=QRMath.gexp(QRMath.glog(_this.getAt(i))+QRMath.glog(e.getAt(j)));}}return qrPolynomial(num,0);};_this.mod=function(e){if(_this.getLength()-e.getLength()<0){return _this;}var ratio=QRMath.glog(_this.getAt(0))-QRMath.glog(e.getAt(0));var num=new Array(_this.getLength());for(var i=0;i<_this.getLength();i+=1){num[i]=_this.getAt(i);}for(var i=0;i<e.getLength();i+=1){num[i]^=QRMath.gexp(QRMath.glog(e.getAt(i))+ratio);}return qrPolynomial(num,0).mod(e);};return _this;}var QRRSBlock=function(){var RS_BLOCK_TABLE=[[1,26,19],[1,26,16],[1,26,13],[1,26,9],[1,44,34],[1,44,28],[1,44,22],[1,44,16],[1,70,55],[1,70,44],[2,35,17],[2,35,13],[1,100,80],[2,50,32],[2,50,24],[4,25,9],[1,134,108],[2,67,43],[2,33,15,2,34,16],[2,33,11,2,34,12],[2,86,68],[4,43,27],[4,43,19],[4,43,15],[2,98,78],[4,49,31],[2,32,14,4,33,15],[4,39,13,1,40,14],[2,121,97],[2,60,38,2,61,39],[4,40,18,2,41,19],[4,40,14,2,41,15],[2,146,116],[3,58,36,2,59,37],[4,36,16,4,37,17],[4,36,12,4,37,13],[2,86,68,2,87,69],[4,69,43,1,70,44],[6,43,19,2,44,20],[6,43,15,2,44,16],[4,101,81],[1,80,50,4,81,51],[4,50,22,4,51,23],[3,36,12,8,37,13],[2,116,92,2,117,93],[6,58,36,2,59,37],[4,46,20,6,47,21],[7,42,14,4,43,15],[4,133,107],[8,59,37,1,60,38],[8,44,20,4,45,21],[12,33,11,4,34,12],[3,145,115,1,146,116],[4,64,40,5,65,41],[11,36,16,5,37,17],[11,36,12,5,37,13],[5,109,87,1,110,88],[5,65,41,5,66,42],[5,54,24,7,55,25],[11,36,12,7,37,13],[5,122,98,1,123,99],[7,73,45,3,74,46],[15,43,19,2,44,20],[3,45,15,13,46,16],[1,135,107,5,136,108],[10,74,46,1,75,47],[1,50,22,15,51,23],[2,42,14,17,43,15],[5,150,120,1,151,121],[9,69,43,4,70,44],[17,50,22,1,51,23],[2,42,14,19,43,15],[3,141,113,4,142,114],[3,70,44,11,71,45],[17,47,21,4,48,22],[9,39,13,16,40,14],[3,135,107,5,136,108],[3,67,41,13,68,42],[15,54,24,5,55,25],[15,43,15,10,44,16],[4,144,116,4,145,117],[17,68,42],[17,50,22,6,51,23],[19,46,16,6,47,17],[2,139,111,7,140,112],[17,74,46],[7,54,24,16,55,25],[34,37,13],[4,151,121,5,152,122],[4,75,47,14,76,48],[11,54,24,14,55,25],[16,45,15,14,46,16],[6,147,117,4,148,118],[6,73,45,14,74,46],[11,54,24,16,55,25],[30,46,16,2,47,17],[8,132,106,4,133,107],[8,75,47,13,76,48],[7,54,24,22,55,25],[22,45,15,13,46,16],[10,142,114,2,143,115],[19,74,46,4,75,47],[28,50,22,6,51,23],[33,46,16,4,47,17],[8,152,122,4,153,123],[22,73,45,3,74,46],[8,53,23,26,54,24],[12,45,15,28,46,16],[3,147,117,10,148,118],[3,73,45,23,74,46],[4,54,24,31,55,25],[11,45,15,31,46,16],[7,146,116,7,147,117],[21,73,45,7,74,46],[1,53,23,37,54,24],[19,45,15,26,46,16],[5,145,115,10,146,116],[19,75,47,10,76,48],[15,54,24,25,55,25],[23,45,15,25,46,16],[13,145,115,3,146,116],[2,74,46,29,75,47],[42,54,24,1,55,25],[23,45,15,28,46,16],[17,145,115],[10,74,46,23,75,47],[10,54,24,35,55,25],[19,45,15,35,46,16],[17,145,115,1,146,116],[14,74,46,21,75,47],[29,54,24,19,55,25],[11,45,15,46,46,16],[13,145,115,6,146,116],[14,74,46,23,75,47],[44,54,24,7,55,25],[59,46,16,1,47,17],[12,151,121,7,152,122],[12,75,47,26,76,48],[39,54,24,14,55,25],[22,45,15,41,46,16],[6,151,121,14,152,122],[6,75,47,34,76,48],[46,54,24,10,55,25],[2,45,15,64,46,16],[17,152,122,4,153,123],[29,74,46,14,75,47],[49,54,24,10,55,25],[24,45,15,46,46,16],[4,152,122,18,153,123],[13,74,46,32,75,47],[48,54,24,14,55,25],[42,45,15,32,46,16],[20,147,117,4,148,118],[40,75,47,7,76,48],[43,54,24,22,55,25],[10,45,15,67,46,16],[19,148,118,6,149,119],[18,75,47,31,76,48],[34,54,24,34,55,25],[20,45,15,61,46,16]];var qrRSBlock=function(totalCount,dataCount){var _this={};_this.totalCount=totalCount;_this.dataCount=dataCount;return _this;};var _this={};var getRsBlockTable=function(typeNumber,errorCorrectionLevel){switch(errorCorrectionLevel){case QRErrorCorrectionLevel.L:return RS_BLOCK_TABLE[(typeNumber-1)*4+0];case QRErrorCorrectionLevel.M:return RS_BLOCK_TABLE[(typeNumber-1)*4+1];case QRErrorCorrectionLevel.Q:return RS_BLOCK_TABLE[(typeNumber-1)*4+2];case QRErrorCorrectionLevel.H:return RS_BLOCK_TABLE[(typeNumber-1)*4+3];default:return undefined;}};_this.getRSBlocks=function(typeNumber,errorCorrectionLevel){var rsBlock=getRsBlockTable(typeNumber,errorCorrectionLevel);if(typeof rsBlock=='undefined'){throw'bad rs block @ typeNumber:'+typeNumber+'/errorCorrectionLevel:'+errorCorrectionLevel;}var length=rsBlock.length/3;var list=[];for(var i=0;i<length;i+=1){var count=rsBlock[i*3+0];var totalCount=rsBlock[i*3+1];var dataCount=rsBlock[i*3+2];for(var j=0;j<count;j+=1){list.push(qrRSBlock(totalCount,dataCount));}}return list;};return _this;}();var qrNumber=function(data){var _mode=QRMode.MODE_NUMBER;var _data=data;var _this={};_this.getMode=function(){return _mode;};_this.getLength=function(buffer){return _data.length;};_this.write=function(buffer){var data=_data;var i=0;while(i+2<data.length){buffer.put(strToNum(data.substring(i,i+3)),10);i+=3;}if(i<data.length){if(data.length-i==1){buffer.put(strToNum(data.substring(i,i+1)),4);}else if(data.length-i==2){buffer.put(strToNum(data.substring(i,i+2)),7);}}};var strToNum=function(s){var num=0;for(var i=0;i<s.length;i+=1){num=num*10+chatToNum(s.charAt(i));}return num;};var chatToNum=function(c){if('0'<=c&&c<='9'){return c.charCodeAt(0)-'0'.charCodeAt(0);}throw'illegal char :'+c;};return _this;};var qrAlphaNum=function(data){var _mode=QRMode.MODE_ALPHA_NUM;var _data=data;var _this={};_this.getMode=function(){return _mode;};_this.getLength=function(buffer){return _data.length;};_this.write=function(buffer){var s=_data;var i=0;while(i+1<s.length){buffer.put(getCode(s.charAt(i))*45+getCode(s.charAt(i+1)),11);i+=2;}if(i<s.length){buffer.put(getCode(s.charAt(i)),6);}};var getCode=function(c){if('0'<=c&&c<='9'){return c.charCodeAt(0)-'0'.charCodeAt(0);}else if('A'<=c&&c<='Z'){return c.charCodeAt(0)-'A'.charCodeAt(0)+10;}else{switch(c){case' ':return 36;case'$':return 37;case'%':return 38;case'*':return 39;case'+':return 40;case'-':return 41;case'.':return 42;case'/':return 43;case':':return 44;default:throw'illegal char :'+c;}}};return _this;};var qr8BitByte=function(data){var _mode=QRMode.MODE_8BIT_BYTE;var _data=data;var _bytes=qrcode.stringToBytes(data);var _this={};_this.getMode=function(){return _mode;};_this.getLength=function(buffer){return _bytes.length;};_this.write=function(buffer){for(var i=0;i<_bytes.length;i+=1){buffer.put(_bytes[i],8);}};return _this;};var qrKanji=function(data){var _mode=QRMode.MODE_KANJI;var _data=data;var stringToBytes=qrcode.stringToBytesFuncs['SJIS'];if(!stringToBytes){throw'sjis not supported.';}!function(c,code){var test=stringToBytes(c);if(test.length!=2||(test[0]<<8|test[1])!=code){throw'sjis not supported.';}}('\u53cb',0x9746);var _bytes=stringToBytes(data);var _this={};_this.getMode=function(){return _mode;};_this.getLength=function(buffer){return~~(_bytes.length/2);};_this.write=function(buffer){var data=_bytes;var i=0;while(i+1<data.length){var c=((0xff&data[i])<<8)|(0xff&data[i+1]);if(0x8140<=c&&c<=0x9FFC){c-=0x8140;}else if(0xE040<=c&&c<=0xEBBF){c-=0xC140;}else{throw'illegal char at '+(i+1)+'/'+c;}c=((c>>>8)&0xff)*0xC0+(c&0xff);buffer.put(c,13);i+=2;}if(i<data.length){throw'illegal char at '+(i+1);}};return _this;};var qrBitBuffer=function(){var _buffer=[];var _length=0;var _this={};_this.getBuffer=function(){return _buffer;};_this.getAt=function(index){var bufIndex=Math.floor(index/8);return((_buffer[bufIndex]>>>(7-index%8))&1)==1;};_this.put=function(num,length){for(var i=0;i<length;i+=1){_this.putBit(((num>>>(length-i-1))&1)==1);}};_this.getLengthInBits=function(){return _length;};_this.putBit=function(bit){var bufIndex=Math.floor(_length/8);if(_buffer.length<=bufIndex){_buffer.push(0);}if(bit){_buffer[bufIndex]|=(0x80>>>(_length%8));}_length+=1;};return _this;};var gifImage=function(width,height){var _width=width;var _height=height;var _data=new Array(width*height);var _this={};_this.setPixel=function(x,y,pixel){_data[y*_width+x]=pixel;};_this.write=function(out){out.writeString('GIF87a');out.writeShort(_width);out.writeShort(_height);out.writeByte(0x80);out.writeByte(0);out.writeByte(0);out.writeByte(0x00);out.writeByte(0x00);out.writeByte(0x00);out.writeByte(0xff);out.writeByte(0xff);out.writeByte(0xff);out.writeString(',');out.writeShort(0);out.writeShort(0);out.writeShort(_width);out.writeShort(_height);out.writeByte(0);var lzwMinCodeSize=2;var raster=getLZWRaster(lzwMinCodeSize);out.writeByte(lzwMinCodeSize);var offset=0;while(raster.length-offset>255){out.writeByte(255);for(var i=0;i<255;i+=1){out.writeByte(raster[offset+i]);}offset+=255;}out.writeByte(raster.length-offset);for(var i=0;i<raster.length-offset;i+=1){out.writeByte(raster[offset+i]);}out.writeByte(0x00);out.writeString(';');};var bitOutputStream=function(out){var _out=out;var _bitLength=0;var _bitBuffer=0;var _this={};_this.write=function(data,length){if((data>>>length)!=0){throw'length over';}while(_bitLength+length>=8){_out.writeByte(0xff&((data<<_bitLength)|_bitBuffer));length-=(8-_bitLength);data>>>=(8-_bitLength);_bitBuffer=0;_bitLength=0;}  _bitBuffer=(data<<_bitLength)|_bitBuffer;_bitLength=_bitLength+length;};_this.flush=function(){if(_bitLength>0){_out.writeByte(_bitBuffer);}};return _this;};var getLZWRaster=function(lzwMinCodeSize){var clearCode=1<<lzwMinCodeSize;var endCode=(1<<lzwMinCodeSize)+1;var bitLength=lzwMinCodeSize+1;var table=lzwTable();for(var i=0;i<clearCode;i+=1){table.add(String.fromCharCode(i));}table.add(String.fromCharCode(clearCode));table.add(String.fromCharCode(endCode));var byteOut=byteArrayOutputStream();var bitOut=bitOutputStream(byteOut);bitOut.write(clearCode,bitLength);var dataIndex=0;var s=String.fromCharCode(_data[dataIndex]);dataIndex+=1;while(dataIndex<_data.length){var c=String.fromCharCode(_data[dataIndex]);dataIndex+=1;if(table.contains(s+c)){s=s+c;}else{bitOut.write(table.indexOf(s),bitLength);if(table.size()<0xfff){if(table.size()==(1<<bitLength)){bitLength+=1;}table.add(s+c);}s=c;}}bitOut.write(table.indexOf(s),bitLength);bitOut.write(endCode,bitLength);bitOut.flush();return byteOut.toByteArray();};var lzwTable=function(){var _map={};var _size=0;var _this={};_this.add=function(key){if(_this.contains(key)){throw'dup key:'+key;}_map[key]=_size;_size+=1;};_this.size=function(){return _size;};_this.indexOf=function(key){return _map[key];};_this.contains=function(key){return typeof _map[key]!='undefined';};return _this;};return _this;};var byteArrayOutputStream=function(){var _bytes=[];var _this={};_this.writeByte=function(b){_bytes.push(b&0xff);};_this.writeShort=function(i){_this.writeByte(i);_this.writeByte(i>>>8);};_this.writeString=function(s){for(var i=0;i<s.length;i+=1){_this.writeByte(s.charCodeAt(i));}};_this.toByteArray=function(){return _bytes;};_this.toString=function(){var s='';s+='[';for(var i=0;i<_bytes.length;i+=1){if(i>0){s+=',';}s+=_bytes[i];}s+=']';return s;};return _this;};qrcode.stringToBytesFuncs={'default':qrcode.stringToBytes};qrcode.createStringToBytesFuncs=function(){};return qrcode;}();
    </script>

    <script>
        // Translations for UI internationalization
        const TRANSLATIONS = {
            de: {
                title: 'Echtzeit-SprachÃ¼bersetzung',
                subtitle: 'Echtzeit-Transkription & Ãœbersetzung',
                defaultMic: 'Standard-Mikrofon',
                selectLanguage: '-- Sprache wÃ¤hlen --',
                selectLanguageFirst: 'Bitte wÃ¤hlen Sie zuerst eine Sprache aus',
                startRecording: 'Aufnahme starten',
                stopRecording: 'Aufnahme stoppen',
                clear: 'LÃ¶schen',
                statusReady: 'Klicken Sie auf "Aufnahme starten"',
                foreignLang: 'Fremdsprache',
                german: 'Deutsch',
                shareTitle: 'Mit GesprÃ¤chspartner teilen',
                shareSubtitle: 'QR-Code scannen fÃ¼r Live-Transkript',
                statusMicRequest: 'Mikrofonzugriff wird angefordert...',
                statusConnecting: 'Verbindung zum Server...',
                statusRecording: 'Verbunden - Aufnahme lÃ¤uft...',
                statusSpeaking: 'Aufnahme... (spricht: {lang})',
                statusStopped: 'Aufnahme beendet',
                statusConnError: 'Verbindungsfehler',
                statusConnClosed: 'Verbindung geschlossen',
                errorHttps: 'Fehler: Mikrofon erfordert HTTPS oder localhost',
                errorBrowser: 'Fehler: Browser unterstÃ¼tzt keinen Mikrofonzugriff',
                errorMicDenied: 'Mikrofonzugriff verweigert',
                speaker: 'Sprecher {n}'
            },
            en: {
                title: 'Real-time Speech Translation',
                subtitle: 'Real-time Speech Transcription & Translation',
                defaultMic: 'Default Microphone',
                selectLanguage: '-- Select Language --',
                selectLanguageFirst: 'Please select a language first',
                startRecording: 'Start Recording',
                stopRecording: 'Stop Recording',
                clear: 'Clear',
                statusReady: 'Click "Start Recording" to begin',
                foreignLang: 'Foreign Language',
                german: 'German',
                shareTitle: 'Share with Foreign Speaker',
                shareSubtitle: 'Scan to view live transcript',
                statusMicRequest: 'Requesting microphone access...',
                statusConnecting: 'Connecting to server...',
                statusRecording: 'Connected - Recording...',
                statusSpeaking: 'Recording... (speaking: {lang})',
                statusStopped: 'Recording stopped',
                statusConnError: 'Connection error',
                statusConnClosed: 'Connection closed',
                errorHttps: 'Error: Microphone requires HTTPS or localhost access',
                errorBrowser: 'Error: Browser does not support microphone access',
                errorMicDenied: 'Microphone access denied',
                speaker: 'Speaker {n}'
            }
        };

        // Current UI language (default: German)
        let currentUiLang = localStorage.getItem('uiLang') || 'de';

        // Translation function
        function t(key, replacements = {}) {
            let text = TRANSLATIONS[currentUiLang]?.[key] || TRANSLATIONS['en']?.[key] || key;
            for (const [k, v] of Object.entries(replacements)) {
                text = text.replace(`{${k}}`, v);
            }
            return text;
        }

        const startBtn = document.getElementById('startBtn');
        const clearBtn = document.getElementById('clearBtn');
        const languageSelect = document.getElementById('languageSelect');
        const audioInputSelect = document.getElementById('audioInputSelect');
        const statusEl = document.getElementById('status');
        const qrCodeEl = document.getElementById('qrCode');
        const viewerUrlText = document.getElementById('viewerUrlText');
        const leftTranscript = document.getElementById('leftTranscript');
        const rightTranscript = document.getElementById('rightTranscript');
        const leftLangLabel = document.getElementById('leftLangLabel');
        const rightLangLabel = document.getElementById('rightLangLabel');
        const uiLangSelect = document.getElementById('uiLangSelect');
        const subtitleEl = document.getElementById('subtitle');

        // Language display names
        const LANG_NAMES = {
            'en': 'English', 'de': 'German', 'fr': 'French', 'es': 'Spanish',
            'it': 'Italian', 'pl': 'Polish', 'ro': 'Romanian', 'hr': 'Croatian',
            'bg': 'Bulgarian', 'sq': 'Albanian', 'tr': 'Turkish', 'ru': 'Russian',
            'uk': 'Ukrainian', 'hu': 'Hungarian', 'ar': 'Arabic', 'fa': 'Persian',
            'sr': 'Serbian'
        };

        let isRecording = false;
        let foreignLang = null;  // The detected/selected foreign (non-German) language
        let ws = null;
        let audioContext = null;
        let mediaStream = null;
        let processor = null;
        let sessionCleared = false;  // Guard flag to prevent renderSegments after clear

        const SAMPLE_RATE = 16000;

        // Generate session token on page load
        function generateToken() {
            // Use crypto.randomUUID if available, otherwise fallback
            if (crypto.randomUUID) {
                return crypto.randomUUID().replace(/-/g, '');
            }
            // Fallback for older browsers
            return Array.from(crypto.getRandomValues(new Uint8Array(16)))
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
        }

        const sessionToken = generateToken();

        function generateQRCode(url) {
            qrCodeEl.innerHTML = '';
            const qr = qrcode(0, 'M');
            qr.addData(url);
            qr.make();

            // Create canvas for better quality
            const moduleCount = qr.getModuleCount();
            const cellSize = 5;
            const margin = 3 * cellSize;
            const size = moduleCount * cellSize + margin * 2;

            const canvas = document.createElement('canvas');
            canvas.width = size;
            canvas.height = size;
            const ctx = canvas.getContext('2d');

            // White background
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, size, size);

            // Draw QR modules
            ctx.fillStyle = '#000000';
            for (let row = 0; row < moduleCount; row++) {
                for (let col = 0; col < moduleCount; col++) {
                    if (qr.isDark(row, col)) {
                        ctx.fillRect(
                            col * cellSize + margin,
                            row * cellSize + margin,
                            cellSize,
                            cellSize
                        );
                    }
                }
            }

            qrCodeEl.appendChild(canvas);
        }

        // Generate and display QR code immediately on page load
        function initQRCode() {
            const viewerUrl = window.location.origin + '/viewer/' + sessionToken;
            generateQRCode(viewerUrl);
            viewerUrlText.textContent = viewerUrl;
        }

        // Initialize QR code on page load
        initQRCode();

        // Apply translations to all UI elements
        function applyTranslations() {
            // Header
            if (subtitleEl) subtitleEl.textContent = t('subtitle');

            // Controls - use optional chaining for safety
            const defaultMicOption = audioInputSelect?.querySelector('option[value=""]');
            if (defaultMicOption) defaultMicOption.textContent = t('defaultMic');

            const selectLanguageOption = languageSelect?.querySelector('option[value=""]');
            if (selectLanguageOption) selectLanguageOption.textContent = t('selectLanguage');

            if (startBtn) startBtn.textContent = isRecording ? t('stopRecording') : t('startRecording');
            if (clearBtn) clearBtn.textContent = t('clear');

            // Status (only if showing ready message)
            if (statusEl && (statusEl.textContent.includes('Start') || statusEl.textContent.includes('starten'))) {
                statusEl.textContent = t('statusReady');
            }

            // Pane labels (only if not showing detected language)
            if (!foreignLang && leftLangLabel) {
                leftLangLabel.textContent = t('foreignLang');
            }
            if (rightLangLabel) rightLangLabel.textContent = t('german');

            // QR sidebar
            const qrTitle = document.querySelector('.qr-sidebar h3');
            const qrSubtitle = document.querySelector('.qr-sidebar p');
            if (qrTitle) qrTitle.textContent = t('shareTitle');
            if (qrSubtitle) qrSubtitle.textContent = t('shareSubtitle');
        }

        // Initialize UI language
        uiLangSelect.value = currentUiLang;
        applyTranslations();

        // Handle UI language change
        uiLangSelect.addEventListener('change', (e) => {
            currentUiLang = e.target.value;
            localStorage.setItem('uiLang', currentUiLang);
            applyTranslations();
        });

        async function enumerateDevices() {
            try {
                // Request permission first to get device labels
                const tempStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                tempStream.getTracks().forEach(track => track.stop());

                const devices = await navigator.mediaDevices.enumerateDevices();

                // Clear existing options (except default)
                audioInputSelect.innerHTML = `<option value="">${t('defaultMic')}</option>`;

                devices.forEach(device => {
                    if (device.kind === 'audioinput') {
                        const option = document.createElement('option');
                        option.value = device.deviceId;
                        option.textContent = device.label || `Microphone (${device.deviceId.slice(0, 8)}...)`;
                        audioInputSelect.appendChild(option);
                    }
                });

            } catch (error) {
                console.error('Error enumerating devices:', error);
            }
        }

        // Enumerate devices on page load
        enumerateDevices();
        navigator.mediaDevices.addEventListener('devicechange', enumerateDevices);

        function setStatus(msg, type = '') {
            statusEl.textContent = msg;
            statusEl.className = 'status ' + type;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function renderSegments(segments, serverForeignLang) {
            console.log('renderSegments START:', segments.length, 'segs, foreignLang:', serverForeignLang);
            // Update foreign language from server if detected
            if (serverForeignLang && !foreignLang) {
                foreignLang = serverForeignLang;
                leftLangLabel.textContent = LANG_NAMES[foreignLang] || foreignLang;
            }

            leftTranscript.innerHTML = '';
            rightTranscript.innerHTML = '';
            console.log('Cleared transcripts, rendering...');

            segments.forEach(seg => {
                const segLang = seg.src_lang;
                const translations = seg.translations || {};
                const isGermanSpeaker = (segLang === 'de');
                const liveClass = seg.final ? '' : ' live';
                const speakerId = seg.speaker_id;  // From diarization

                // Determine speaker alignment: SPEAKER_00 = left, SPEAKER_01 = right
                // This keeps consistent positioning regardless of language
                let isSpeakerLeft = true;  // default to left
                if (speakerId && typeof speakerId === 'string') {
                    const speakerNum = parseInt(speakerId.replace('SPEAKER_', ''), 10);
                    isSpeakerLeft = (speakerNum === 0);
                }
                const bubbleClass = isSpeakerLeft ? 'speaker-left' : 'speaker-right';

                // Determine what goes on left (foreign) and right (German)
                let leftText, rightText;
                if (isGermanSpeaker) {
                    // German speaker: source on right pane, translation on left pane
                    rightText = seg.src;
                    leftText = translations[foreignLang] || '...';
                } else {
                    // Foreign speaker: source on left pane, translation on right pane
                    leftText = seg.src;
                    rightText = translations['de'] || '...';
                }

                // Format speaker label (e.g., "SPEAKER_00" -> "Speaker 1" or "Sprecher 1")
                let speakerLabel = '';
                if (speakerId && typeof speakerId === 'string') {
                    const speakerNum = parseInt(speakerId.replace('SPEAKER_', ''), 10);
                    if (!isNaN(speakerNum)) {
                        speakerLabel = t('speaker', { n: speakerNum + 1 });
                    }
                }

                // Left pane (foreign language view)
                const leftDiv = document.createElement('div');
                leftDiv.className = 'bubble ' + bubbleClass + liveClass;
                if (speakerLabel) {
                    leftDiv.innerHTML = `<div class="speaker-label">${speakerLabel}</div><span class="bubble-content">${escapeHtml(leftText)}</span>`;
                } else {
                    leftDiv.textContent = leftText;
                }
                leftDiv.dataset.id = seg.id;
                leftDiv.dataset.srcLang = segLang;
                if (speakerId) leftDiv.dataset.speakerId = speakerId;
                leftTranscript.appendChild(leftDiv);

                // Right pane (German view)
                const rightDiv = document.createElement('div');
                rightDiv.className = 'bubble ' + bubbleClass + liveClass;
                if (speakerLabel) {
                    rightDiv.innerHTML = `<div class="speaker-label">${speakerLabel}</div><span class="bubble-content">${escapeHtml(rightText)}</span>`;
                } else {
                    rightDiv.textContent = rightText;
                }
                rightDiv.dataset.id = seg.id;
                rightDiv.dataset.srcLang = segLang;
                if (speakerId) rightDiv.dataset.speakerId = speakerId;
                rightTranscript.appendChild(rightDiv);
            });

            console.log('Rendered', segments.length, 'segments, children:', leftTranscript.children.length);

            // Auto-scroll after DOM update - use requestAnimationFrame to ensure layout is complete
            requestAnimationFrame(() => {
                const leftPane = leftTranscript.parentElement;
                const rightPane = rightTranscript.parentElement;
                if (leftPane) {
                    leftPane.scrollTop = leftPane.scrollHeight;
                }
                if (rightPane) {
                    rightPane.scrollTop = rightPane.scrollHeight;
                }
            });
            console.log('renderSegments END');
        }

        function updateTranslation(segmentId, tgtLang, text) {
            // Find the bubble elements by ID
            const leftDiv = leftTranscript.querySelector(`[data-id="${segmentId}"]`);
            const rightDiv = rightTranscript.querySelector(`[data-id="${segmentId}"]`);

            if (!leftDiv || !rightDiv) return;

            // Determine which pane needs the translation update
            const isGermanSpeaker = (leftDiv.dataset.srcLang === 'de');

            // Update the bubble content (handles both plain text and speaker-labeled bubbles)
            function updateBubbleContent(div, newText) {
                const contentSpan = div.querySelector('.bubble-content');
                if (contentSpan) {
                    contentSpan.textContent = newText || '...';
                } else {
                    div.textContent = newText || '...';
                }
            }

            if (isGermanSpeaker) {
                // German speaker: translation goes to left (foreign) pane
                if (tgtLang !== 'de') {
                    updateBubbleContent(leftDiv, text);
                }
            } else {
                // Foreign speaker: translation goes to right (German) pane
                if (tgtLang === 'de') {
                    updateBubbleContent(rightDiv, text);
                }
            }
        }

        function downsampleBuffer(buffer, inputSampleRate, outputSampleRate) {
            if (inputSampleRate === outputSampleRate) {
                return buffer;
            }
            const ratio = inputSampleRate / outputSampleRate;
            const newLength = Math.round(buffer.length / ratio);
            const result = new Float32Array(newLength);
            for (let i = 0; i < newLength; i++) {
                const srcIndex = i * ratio;
                const srcIndexFloor = Math.floor(srcIndex);
                const srcIndexCeil = Math.min(srcIndexFloor + 1, buffer.length - 1);
                const t = srcIndex - srcIndexFloor;
                result[i] = buffer[srcIndexFloor] * (1 - t) + buffer[srcIndexCeil] * t;
            }
            return result;
        }

        function floatTo16BitPCM(float32Array) {
            const int16Array = new Int16Array(float32Array.length);
            for (let i = 0; i < float32Array.length; i++) {
                const s = Math.max(-1, Math.min(1, float32Array[i]));
                int16Array[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
            }
            return int16Array.buffer;
        }

        async function startRecording() {
            // Reset the cleared flag when starting a new session
            sessionCleared = false;

            // Check for secure context (HTTPS or localhost)
            if (!window.isSecureContext) {
                setStatus(t('errorHttps'), 'error');
                alert('Microphone access requires a secure context.\n\nOptions:\n1. Access via http://localhost:8000\n2. Use SSH tunnel: ssh -L 8000:localhost:8000 user@server\n3. Launch Chrome with: --unsafely-treat-insecure-origin-as-secure=http://' + window.location.host);
                return;
            }

            // Check if getUserMedia is available
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                setStatus(t('errorBrowser'), 'error');
                return;
            }

            try {
                setStatus(t('statusMicRequest'), '');

                const audioConstraints = {
                    channelCount: 1,
                    sampleRate: { ideal: 48000 },
                    echoCancellation: true,
                    noiseSuppression: true
                };

                // Use selected input device if specified
                const selectedInputId = audioInputSelect.value;
                if (selectedInputId) {
                    audioConstraints.deviceId = { exact: selectedInputId };
                }

                mediaStream = await navigator.mediaDevices.getUserMedia({
                    audio: audioConstraints
                });

                audioContext = new AudioContext({ sampleRate: 48000 });
                const source = audioContext.createMediaStreamSource(mediaStream);

                processor = audioContext.createScriptProcessor(4096, 1, 1);

                const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${wsProtocol}//${window.location.host}/ws`;

                setStatus(t('statusConnecting'), '');
                ws = new WebSocket(wsUrl);

                ws.onopen = () => {
                    // Keep "Connecting..." status until config_ack is received

                    // Set foreign language from selection if not "auto" or "de"
                    const selectedLang = languageSelect.value;
                    if (selectedLang !== 'auto' && selectedLang !== 'de') {
                        foreignLang = selectedLang;
                        leftLangLabel.textContent = LANG_NAMES[foreignLang] || foreignLang;
                    }

                    const config = {
                        type: 'config',
                        sample_rate: SAMPLE_RATE,
                        src_lang: selectedLang,
                        foreign_lang: (selectedLang !== 'auto' && selectedLang !== 'de') ? selectedLang : null,
                        token: sessionToken
                    };
                    ws.send(JSON.stringify(config));

                    source.connect(processor);
                    processor.connect(audioContext.destination);
                };

                ws.onmessage = (event) => {
                    // Guard: ignore messages if session was cleared
                    if (sessionCleared) {
                        console.log('WS message ignored (session cleared)');
                        return;
                    }
                    try {
                        const data = JSON.parse(event.data);
                        console.log('WS message:', data.type, data.segments?.length || 0);
                        if (data.type === 'config_ack') {
                            console.log('Config acknowledged:', data.status);
                            setStatus(t('statusRecording'), 'connected');
                        } else if (data.type === 'error') {
                            console.error('Server error:', data.message);
                            setStatus(data.message || t('statusConnError'), 'error');
                        } else if (data.type === 'segments' && data.segments) {
                            console.log('Calling renderSegments with', data.segments.length, 'segments');
                            renderSegments(data.segments, data.foreign_lang);
                            console.log('renderSegments completed');
                            // Update dual-channel indicator
                            const badge = document.getElementById('dualChannelBadge');
                            if (data.dual_channel) {
                                badge.classList.add('active');
                            } else {
                                badge.classList.remove('active');
                            }
                            if (data.src_lang && data.src_lang !== 'unknown') {
                                const langName = LANG_NAMES[data.src_lang] || data.src_lang;
                                setStatus(t('statusSpeaking', { lang: langName }), 'connected');
                            }
                        } else if (data.type === 'translation') {
                            // Update translation for specific segment
                            updateTranslation(data.segment_id, data.tgt_lang, data.text);
                        }
                    } catch (e) {
                        console.error('WebSocket message error:', e, e.stack);
                    }
                };

                ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    setStatus(t('statusConnError'), 'error');
                };

                ws.onclose = () => {
                    if (isRecording) {
                        setStatus(t('statusConnClosed'), 'error');
                    }
                };

                let frameCount = 0;
                processor.onaudioprocess = (e) => {
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        const inputData = e.inputBuffer.getChannelData(0);

                        // Debug: log audio levels every 50 frames
                        frameCount++;
                        if (frameCount % 50 === 1) {
                            const rms = Math.sqrt(inputData.reduce((sum, x) => sum + x * x, 0) / inputData.length);
                            const max = Math.max(...inputData.map(Math.abs));
                            console.log(`Audio frame ${frameCount}: rms=${rms.toFixed(4)}, max=${max.toFixed(4)}, len=${inputData.length}`);
                        }

                        const downsampled = downsampleBuffer(inputData, audioContext.sampleRate, SAMPLE_RATE);
                        const pcm16 = floatTo16BitPCM(downsampled);
                        ws.send(pcm16);
                    }
                };

                isRecording = true;
                startBtn.textContent = t('stopRecording');
                startBtn.classList.add('recording');
                languageSelect.disabled = true;
                audioInputSelect.disabled = true;

            } catch (error) {
                console.error('Error starting recording:', error);
                setStatus(t('errorMicDenied'), 'error');
            }
        }

        function stopRecording() {
            isRecording = false;

            // Stop audio capture
            if (processor) {
                processor.disconnect();
                processor = null;
            }

            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }

            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }

            // Tell server to stop (drains translations and sends final segments)
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'request_summary' }));
            }

            if (ws) {
                ws.close();
                ws = null;
            }

            startBtn.textContent = t('startRecording');
            startBtn.classList.remove('recording');
            startBtn.disabled = false;
            languageSelect.disabled = false;
            audioInputSelect.disabled = false;
            setStatus(t('statusStopped'), '');
        }

        // Disable start button until language is selected
        function updateStartButtonState() {
            const hasLanguage = languageSelect.value !== '';
            startBtn.disabled = !hasLanguage && !isRecording;
            if (!hasLanguage && !isRecording) {
                startBtn.title = t('selectLanguageFirst');
            } else {
                startBtn.title = '';
            }
        }

        languageSelect.addEventListener('change', updateStartButtonState);
        updateStartButtonState(); // Initial state

        startBtn.addEventListener('click', () => {
            if (isRecording) {
                stopRecording();
            } else {
                if (!languageSelect.value) {
                    alert(t('selectLanguageFirst'));
                    return;
                }
                startRecording();
            }
        });

        clearBtn.addEventListener('click', () => {
            // Set guard flag FIRST to block any pending WebSocket messages
            sessionCleared = true;
            console.log('Cleared: sessionCleared =', sessionCleared);

            // Stop recording to prevent new messages
            if (isRecording) {
                // Force stop without server notification
                isRecording = false;
                if (processor) {
                    processor.disconnect();
                    processor = null;
                }
                if (audioContext) {
                    audioContext.close();
                    audioContext = null;
                }
                if (mediaStream) {
                    mediaStream.getTracks().forEach(track => track.stop());
                    mediaStream = null;
                }
                if (ws) {
                    ws.close();
                    ws = null;
                }
                startBtn.textContent = t('startRecording');
                startBtn.classList.remove('recording');
                languageSelect.disabled = false;
                audioInputSelect.disabled = false;
            }
            // Clear display
            leftTranscript.innerHTML = '';
            rightTranscript.innerHTML = '';
            foreignLang = null;
            leftLangLabel.textContent = t('foreignLang');
            setStatus(t('statusReady'), '');
        });
    </script>
</body>
</html>
